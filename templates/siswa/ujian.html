{% extends "base.html" %}

{% block title %}{{ ujian.nama_ujian }} - Sistem Ujian Online{% endblock %}

{% block content %}
<div class="proctor-container">
    <!-- Header -->
    <div class="proctor-header">
        <div class="d-flex justify-content-between align-items-center w-100">
            <div>
                <h5 class="mb-0">{{ ujian.nama_ujian }}</h5>
                <small>{{ current_user.nama_lengkap }}</small>
            </div>
            <div class="text-center">
                <div id="timer" class="timer-display">{{ ujian.durasi_menit }}:00:00</div>
            </div>
            <div class="text-end">
                <button class="btn btn-danger btn-sm" id="btnSubmit">
                    <i class="fas fa-paper-plane"></i> Selesai Ujian
                </button>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="proctor-content">
        <!-- Camera Section -->
        <div class="camera-section">
            <h6 class="text-white mb-3">
                <i class="fas fa-video"></i> Monitoring Proctor
            </h6>
            
            <video id="videoElement" autoplay muted></video>
            
            <div id="violationCounter" class="warning-counter bg-success mt-3">
                0/3 Pelanggaran
            </div>
            
            <div class="mt-3">
                <h6 class="text-white">Status Monitoring:</h6>
                <div id="proctorStatus" class="text-success">
                    <i class="fas fa-check-circle"></i> Aktif
                </div>
            </div>
            
            <div class="mt-3">
                <h6 class="text-white">Navigasi Soal:</h6>
                <div class="soal-navigation bg-dark p-2 rounded">
                    {% for i in range(1, soal_list|length + 1) %}
                        <button class="btn btn-soal" data-soal="{{ i }}">{{ i }}</button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Ujian Section -->
        <div class="ujian-section">
            {% for soal in soal_list %}
            <div class="soal-container" id="soal_{{ loop.index }}" style="display: {{ 'block' if loop.first else 'none' }}">
                <div class="soal-header">
                    <h6>Soal {{ loop.index }} dari {{ soal_list|length }}</h6>
                </div>
                
                <div class="mb-4">
                    <h5>{{ soal.pertanyaan }}</h5>
                </div>
                
                <div class="pilihan-jawaban">
                    <input type="radio" id="soal_{{ soal.id }}_a" name="soal_{{ soal.id }}" value="A">
                    <label for="soal_{{ soal.id }}_a">A. {{ soal.pilihan_a }}</label>
                </div>
                
                <div class="pilihan-jawaban">
                    <input type="radio" id="soal_{{ soal.id }}_b" name="soal_{{ soal.id }}" value="B">
                    <label for="soal_{{ soal.id }}_b">B. {{ soal.pilihan_b }}</label>
                </div>
                
                <div class="pilihan-jawaban">
                    <input type="radio" id="soal_{{ soal.id }}_c" name="soal_{{ soal.id }}" value="C">
                    <label for="soal_{{ soal.id }}_c">C. {{ soal.pilihan_c }}</label>
                </div>
                
                <div class="pilihan-jawaban">
                    <input type="radio" id="soal_{{ soal.id }}_d" name="soal_{{ soal.id }}" value="D">
                    <label for="soal_{{ soal.id }}_d">D. {{ soal.pilihan_d }}</label>
                </div>
                
                <div class="mt-4 d-flex justify-content-between">
                    <button class="btn btn-secondary" id="btnPrev" {{ 'disabled' if loop.first }}>
                        <i class="fas fa-chevron-left"></i> Sebelumnya
                    </button>
                    
                    <button class="btn btn-primary" id="btnNext" {{ 'disabled' if loop.last }}>
                        Selanjutnya <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize exam proctor
    const ujianProctor = new UjianProctor({{ ujian.id }}, {{ ujian.durasi_menit }});
    ujianProctor.totalSoal = {{ soal_list|length }};
    
    // Set current soal to 1
    ujianProctor.navigateToSoal(1);
    
    // Prevent page refresh/close without confirmation
    window.addEventListener('beforeunload', function(e) {
        if (ujianProctor.isExamActive) {
            e.preventDefault();
            e.returnValue = 'Ujian sedang berlangsung. Yakin ingin keluar?';
            return e.returnValue;
        }
    });
    
    // Fullscreen mode
    document.documentElement.requestFullscreen().catch(err => {
        console.log('Fullscreen not supported');
    });
    
    // Detect fullscreen exit
    document.addEventListener('fullscreenchange', function() {
        if (!document.fullscreenElement && ujianProctor.isExamActive) {
            ujianProctor.triggerViolation('Keluar dari mode fullscreen', 'ringan');
        }
    });
});
</script>
{% endblock %}